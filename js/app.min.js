$(window).scroll(function() {    
    var scroll = $(window).scrollTop();
    if (scroll >= 560) {
        $("section#float-header").addClass("z-index");
    } else {
        $("section#float-header").removeClass("z-index");
    }

    if (scroll >= 620) {
        $("#icon-nav.detail-page").addClass("hidden");
    } else {
        $("#icon-nav.detail-page").removeClass("hidden");
    }

    if (scroll >= 680) {
        $("section#float-header, section#detail-content").addClass("fixed-nav");
    } else {
        $("section#float-header, section#detail-content").removeClass("fixed-nav");
    }

    //float nav hidden
    if ($('section#detail-about').length) {
        var hT = $('section#detail-about').offset().top,
            hH = $('section#detail-about').outerHeight(),
            wH = $(window).height(),
            wS = $(this).scrollTop();
        if (wS > (hT+hH-wH)){
            $('section#float-header').addClass("nav-out");
            $('#icon-nav').addClass("icon-in");
        }else {
            $('section#float-header').removeClass("nav-out");
            $('#icon-nav').removeClass("icon-in");
        }
    }
});


$(function(){
    //loading
    setTimeout(function(){
        $("aside#loading").fadeOut().remove();
    }, 900);

    //header title full screen
    function i(){
        var i=$(window).height();
        $("section#fixed-animation").css({minHeight:i});
    }
    i();
    $(window).resize(function(){ i(); });

    function handleResize() {
        var mediaHeight = $(window).height();
        $("header#home-header, header#home-header .wrap, header#home-header .header-title").css({height: mediaHeight});
    }
    handleResize();
    $(window).resize(function(){ handleResize(); });
    
    //navigation
    $("a.open-navigation, a.open-nav").click(function(){
        $("a.open-navigation").addClass("x");
        $("aside#circle > span").addClass("x");
        $("aside#fade-bg").fadeIn().addClass("x");
        $("aside#navigation").addClass("x");
        return false;
    });

    $("a.open-navigation > div").click(function(){
        $(this).parent().removeClass("x");
        $("aside#circle > span").addClass("xy");
        $("aside#fade-bg").fadeOut().removeClass("x");
        $("aside#navigation").removeClass("x");
        setTimeout(function(){
            $("aside#circle > span").removeClass("x xy");
            $("aside#fade-bg");
        }, 280);
        return false;
    });

    $('aside#fade-bg').click(function(e) {
        if ($(e.target).is('aside#fade-bg')) {
            $("a.open-navigation").removeClass("x");
            $(this).fadeOut().removeClass("x");
            $("aside#circle > span").addClass("xy");
            $("aside#navigation").removeClass("x");
            setTimeout(function(){
                $("aside#circle > span").removeClass("x xy");
            }, 280);
            return false;
        }
    });

    //category menu
    $('.roll-list > a').click(function(e) {
        $(this).toggleClass("x");
        $(".roll-list > ul").fadeToggle(200);
        return false;
    });
    $('.roll-list > a').on('click', function(f) { f.stopPropagation(); });
    $(document).on('click', function(f) {
        $(".roll-list > a").removeClass("x");
        $(".roll-list > ul").fadeOut(200);
    });

    // course pagination
    $(document).on('click', '#list-content .load-more-items', function(e)
    {
        e.preventDefault();

        var el = $(this);

        el.addClass('x');

        $.get(el.attr('href'), function(data)
        {
            $(data.html).hide().appendTo('#list-content .all-events').fadeIn('slow');

            if (data.hasMorePages) {
                el.attr('href', data.nextPageUrl);
                el.removeClass('x');
            } else {
                el.remove();
            }
        }, 'json');
    });

    //parallax
    var elements = $('[data-parallax="true"]');
    function draw() {
        requestAnimationFrame(draw);
        scrollEvent();
    }
    $(window).resize(draw);
    function scrollEvent(){

        if(!is_touch_device()){
            viewportTop = $(window).scrollTop();
            windowHeight = $(window).height();
            viewportBottom = windowHeight+viewportTop;

            if($(window).width())

            elements.each(function(){

                if($(window).width() < 900)
                {
                    $(this).attr('data-parallax', false);
                    $(this).css('transform', 'translate3d(0,0,0)');
                    return;
                } else {
                    $(this).attr('data-parallax', 'true');
                }

                distance = viewportTop * $(this).attr('data-scroll-speed');
                if($(this).attr('data-direction') === 'up'){ sym = '-'; } else { sym = ''; }
                $(this).css('transform','translate3d(0, ' + sym + distance +'px,0)');
            });

        }
    }
    draw();
    //touch parallax
    function is_touch_device() {
      //return 'ontouchstart' in window
          //|| 'onmsgesturechange' in window;
    }

    //clones
    $(".author").clone().appendTo(".copyright-nav .wrap");
    // $("section#fixed-animation").clone().appendTo("header#home-header").addClass("ahoj");
    //$("ul.category a.active > span.title").clone().appendTo(".roll-list > a");

    //nosvg
    if ($("html").hasClass("no-svg")) {
        $('img.flb-img[src*="svg"]').attr('src', function() {
            return $(this).attr('src').replace('.svg', '.png');
        });
    }

    // click to scroll
    $("a.scroll-to-form").click(function() {
        $('html, body').animate({
            scrollTop: $("section#detail-form").offset().top
        }, 1000);
        return false;
    });

    //form
    $.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        }
    });

    $(document).on('change', '.js_reg_form .person-count', function() {
        var select = $(this),
            template = $('#form-person-template'),
            destination = $('#form-persons-destionation');

        destination.show();

        destination.nextAll('fieldset').remove();

        for (var i = select.val(); i >= 1; i--) {
            destination.after(template.html().replace(/index/g, i));
        }
    });

    $(document).on('focus', '.js_reg_form label input, .js_reg_form label > select', function() {
        $(this).parent().toggleClass("write")
        $(this).parent().removeClass("wrong");
    })
    .blur(
    function(){
        $(".js_reg_form label").removeClass("write");
    });

    $(document).on('submit', 'form.js_reg_form', function(e) {
        e.preventDefault();

        var form = $(this);

        if ( ! form.hasClass('disabled')) {
            clearTimeout(window.intervalAlertMessage);
            $('.alert-message').removeClass('visible').removeAttr('style');

            form.addClass('disabled');

            $.ajax({
                type: 'post',
                url: form.attr('action'),
                data: form.serialize(),
                dataType: 'json',
                success: function(data) {
                    if (data.success) {
                        form.trigger('reset');

                        form.removeClass('disabled');

                        var template = $('#form-person-template'),
                            destination = $('#form-persons-destionation');

                        destination.nextAll('fieldset').remove();

                        destination.hide();

                        $('#true-message').addClass('visible');

                        window.intervalAlertMessage = setTimeout(function() {
                            $('#true-message').fadeOut(350, function() {
                                $(this).removeClass('visible').removeAttr('style');
                            });
                        }, 6000);

                    }
                },
                error: function(xhr, status, error) {
                    form.removeClass('disabled');
                    
                    $.each(xhr.responseJSON, function(index, val) {
                        $('#form-' + index.replace(/\./g, '-')).addClass('wrong');
                    });

                    $('#false-message').addClass('visible');

                    window.intervalAlertMessage = setTimeout(function() {
                        $('#false-message').fadeOut(350, function() {
                            $(this).removeClass('visible').removeAttr('style');
                        });
                    }, 6000);
                }
            });
        }
    });
});

// ms viewport
if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
    var msViewportStyle = document.createElement("style");
    msViewportStyle.appendChild(
        document.createTextNode(
            "@-ms-viewport{width:auto!important}"
        )
    );
    document.getElementsByTagName("head")[0].
    appendChild(msViewportStyle);
}
